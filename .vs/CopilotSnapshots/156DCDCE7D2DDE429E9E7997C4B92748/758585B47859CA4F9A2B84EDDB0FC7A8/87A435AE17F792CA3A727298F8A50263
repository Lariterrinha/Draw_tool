/* Copyright (c) 2024 Lilian Buzer - All rights reserved - */
#pragma once

#include <string>
#include "Event.h"
#include "Model.h"
#include "ObjGeom.h"

using namespace std;

enum State { WAIT, INTERACT  };

////////////////////////////////////////////////////////////////////

class Tool
{
protected :
	int currentState;

public:
	Tool() {   currentState = State::WAIT; }
	virtual void processEvent(const Event& E, Model & Data) {}

	virtual void draw(Graphics& G,const  Model& Data) {}
};

////////////////////////////////////////////////////////////////////


class ToolSegment : public Tool
{
	V2 Pstart;
public : 

	ToolSegment() : Tool() {}
	void processEvent(const Event& E, Model& Data) override
	{
		if (E.Type == EventType::MouseDown && E.info == "0") // left mouse button pressed
		{
			if (currentState == State::WAIT)
			{
				// interactive drawing
				Pstart = Data.currentMousePos;
				currentState = State::INTERACT;  
				return;
			}
		}

		if (E.Type == EventType::MouseUp && E.info == "0") // left mouse button released
		{
			if (currentState == State::INTERACT)
			{
				// add object in the scene
				V2 P2 = Data.currentMousePos;
				auto newObj = make_shared<ObjSegment>(Data.drawingOptions, Pstart, P2);
				Data.LObjets.push_back(newObj);
				currentState = State::WAIT;
				return;
			}
		}
	}


	void draw(Graphics& G, const Model& Data) override
	{
		if (currentState == State::INTERACT)
  		  G.drawLine(Pstart, Data.currentMousePos, Data.drawingOptions.borderColor_, Data.drawingOptions.thickness_);
	}

};


////////////////////////////////////////////////////////////////////


class ToolRectangle : public Tool
{
protected:
	V2 Pstart;
public:

	ToolRectangle() : Tool() {}
	void processEvent(const Event& E, Model& Data) override
	{
		if (E.Type == EventType::MouseDown && E.info == "0") // left mouse button pressed
		{
			if (currentState == State::WAIT)
			{
				// interactive drawing
				Pstart = Data.currentMousePos;
				currentState = State::INTERACT;
				return;
			}
		}

		if (E.Type == EventType::MouseUp && E.info == "0") // left mouse button released
		{
			if (currentState == State::INTERACT)
			{
				// add object in the scene
				V2 P2 = Data.currentMousePos;
				auto newObj = make_shared<ObjRectangle>(Data.drawingOptions, Pstart, P2);
				Data.LObjets.push_back(newObj);
				currentState = State::WAIT;
				return;
			}
		}
	}

	void draw(Graphics& G, const Model& Data) override
	{
		if (currentState == State::INTERACT){

			// pre-view 
			V2 P; V2 size;
			getPLH(Pstart, Data.currentMousePos, P, size); // normalize

			// retangulo 
			G.drawRectangle(P, size, Data.drawingOptions.borderColor_, true, Data.drawingOptions.thickness_);

			//G.drawRectangle(Pstart, Data.currentMousePos, Data.drawingOptions.borderColor_, Data);
		}
	}
};

class ToolCircle : public Tool
{
protected:
	V2 Pstart;
public:

	ToolCircle() : Tool() {}
	void processEvent(const Event& E, Model& Data) override
	{
		if (E.Type == EventType::MouseDown && E.info == "0") // left mouse button pressed
		{
			if (currentState == State::WAIT)
			{
				// interactive drawing
				Pstart = Data.currentMousePos;
				currentState = State::INTERACT;
				return;
			}
		}

		if (E.Type == EventType::MouseUp && E.info == "0") // left mouse button released
		{
			if (currentState == State::INTERACT)
			{
				// add object in the scene
				V2 P2 = Data.currentMousePos;
				auto newObj = make_shared<ObjCircle>(Data.drawingOptions, Pstart, P2);
				Data.LObjets.push_back(newObj);
				currentState = State::WAIT;
				return;
			}
		}
	}

	void draw(Graphics& G, const Model& Data) override
	{
		if (currentState == State::INTERACT) {

			// pre-view  
			int r;

			V2 diff = Data.currentMousePos - Pstart;
			r = (int)diff.norm();
			
			// circulo 
			G.drawCircle(Pstart,r , Data.drawingOptions.borderColor_, true, Data.drawingOptions.thickness_);

		}
	}
};

class ToolSelect : public Tool
{
protected:
	V2 Pstart;

public:

	ToolSelect() : Tool() {}
	void processEvent(const Event& E, Model& Data) override
	{
		if (E.Type == EventType::MouseDown && E.info == "0") // left mouse button pressed
		{
			if (currentState == State::WAIT)
			{
				//Data.LObjets.find();
				currentState = State::INTERACT;
				return;
			}
		}

		if (E.Type == EventType::MouseUp && E.info == "0") // left mouse button released
		{
			if (currentState == State::INTERACT)
			{
				//	Select object 
				V2 P2 = Data.currentMousePos;
				
				
				
			// toggle
			if (found && selectedObj_ && found.get() == selectedObj_.get())
				selectedObj_.reset();
			else
				selectedObj_ = found;
		}
	}

	// dont draw anything
	void draw(Graphics& G, const Model& Data) override
	{
		if (currentState == State::INTERACT) {
		}
	}
};

